namespace Conway.Tests

open Conway.App.Controls
open Conway.App.File
open Conway.Encoding
open Conway.Core
open NUnit.Framework

module ``Binary Canvas File Loader Tests`` =
    open NUnit.Framework.Legacy

    [<Test>]
    let ``Can correctly load a simple canvas with default camera parameters`` () =
        let expectedGame = new Game(ConwayGrid.createDead 4 4)
        let expectedCamera = new Camera(0.0f, 0.0f, 1.0f)

        let encoding = [|
            0b0000_0000uy // camera X-coordinate (32-bit float)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // camera Y-coordinate (32-bit float)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // camera zoom factor (32-bit float)
            0b0000_0000uy // ...
            0b1000_0000uy // ...
            0b0011_1111uy // ...
            0b0000_0100uy // 4 rows (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0100uy // 4 cols (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0001uy // generation counter (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // 4x4 actual grid with all cells dead
            0b0000_0000uy // ...
            0b0000_0000uy // 4x4 initial grid with all cells dead
            0b0000_0000uy // ...
        |]

        let decoder = ConwayByteDecoder() :> IConwayByteDecoder
        let fileLoader = BinaryCanvasFileLoader decoder
        let actualGame, actualCamera = fileLoader.Decode encoding

        CollectionAssert.AreEqual(actualGame.CurrentState.Board, expectedGame.CurrentState.Board)
        CollectionAssert.AreEqual(actualGame.InitialState.Board, expectedGame.InitialState.Board)
        Assert.That(actualGame.Generation, Is.EqualTo expectedGame.Generation)
        Assert.That(actualCamera.Position, Is.EqualTo expectedCamera.Position)
        Assert.That(actualCamera.ZoomFactor, Is.EqualTo expectedCamera.ZoomFactor)
