namespace Conway.Tests

open Conway.Encoding
open Conway.Core
open NUnit.Framework

module ``Conway Byte Decoder Tests`` =
    open NUnit.Framework.Legacy

    [<Test>]
    let ``Can correctly decode grid dimensions`` () =
        let encoding = [|
            0b0000_0100uy // 4 rows (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0100uy // 4 cols (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0001uy // generation counter (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b1111_1111uy // 4x4 grid with all cells living
            0b1111_1111uy // ...
        |]

        let decoder = ConwayByteDecoder()

        let expectedDimensions = 4, 4
        let actualDimensions = decoder.DecodeDimensions encoding

        Assert.That(actualDimensions, Is.EqualTo expectedDimensions)

    [<Test>]
    let ``Can correctly decode game generation`` () =
        let encoding = [|
            0b0000_0100uy // 4 rows (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0100uy // 4 cols (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0011_1110uy // generation counter (32-bit int)
            0b1100_0011uy // ...
            0b0000_0101uy // ...
            0b0000_0000uy // ...
            0b1111_1111uy // 4x4 grid with all cells living
            0b1111_1111uy // ...
        |]

        let decoder = ConwayByteDecoder()

        let expectedGeneration = 377662
        let actualGeneration = decoder.DecodeGeneration encoding

        Assert.That(actualGeneration, Is.EqualTo expectedGeneration)

    [<Test>]
    let ``Can correctly decode a living grid`` () =
        let encoding = [|
            0b0000_0100uy // 4 rows (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0100uy // 4 cols (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0001uy // generation counter (32-bit int)
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b0000_0000uy // ...
            0b1111_1111uy // 4x4 grid with all cells living
            0b1111_1111uy // ...
            0b0000_0000uy // 4x4 initial state with all cells dead
            0b0000_0000uy // ...
        |]

        let expectedGrid = ConwayGrid.createLiving 4 4

        let encoder = new ConwayByteDecoder()
        let actualGrid = encoder.DecodeGrid encoding

        CollectionAssert.AreEqual(expectedGrid.Board, actualGrid.Board)
